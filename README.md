# Module-Berserk

## TODO (노션에 다음 목표로 포함되지는 않았지만 언젠가 처리해야 할 작업)
- 한 번의 공격에 여러 번 데미지를 입는 상황 방지하기
- 아주 높은 곳에서 추락하는 상황에서 카메라 추적 좌표의 y값 조정하기
  - 지금은 땅에 닿을 때마다 y축 추적이 들어가서 플레이어가 시야 밖으로 나가는 상황도 가능함
  - 만약 맵의 수직 높이가 제한적이라면 지금 상태를 유지해도 상관 없음


## Known Issues
### 플랫폼 끝에 아슬아슬하게 걸치지 않아야 할 위치에서 리지드바디가 멈추는 경우가 드물게 발생함
![이상한 리지드바디](img/weirdrb.png)
- 아니 이게 왜 멈춰???


## 리팩토링 후보 (생각날 때마다 기록)


## 코드로 드러나지 않는 중요한 사항
### Project Setting에서 Physics2D multithreading 옵션 활성화함
- 혹시 나중에 물리 관련해서 오류 발생하면 멀티스레딩을 의심해볼 것

### Pixels Per Unit 및 카메라 Ortho Size
- 모든 스프라이트의 PPU는 32로 설정
- 기준 해상도 480x270을 유니티 단위로 변환하면 아래와 같음

  ||가로|세로|
  |-|-|-|
  |픽셀 단위|480|270|
  |유니티 단위|480 / 32 = 15|270 / 32 = 8.4375|
- 카메라의 Ortho Size는 view 높이의 절반이므로 8.4375 / 2 = 4.21875 unit이 되어야 함

### 충돌 레이어 설정
#### 레이어 분류
- Character: 주인공 또는 적이 사용하는 레이어로 Character끼리는 충돌 x
- Weapon: 공격 범위로 사용하는 콜라이더에 할당되는 레이어. Weapon끼리는 충돌 x
- Interactable: 상호작용 가능한 물체에 할당되는 레이어. Character만 충돌 가능.
- Ground: 밟을 수 있는 지형지물에 할당되는 레이어.
#### 사용 예시
- 주인공 본체는 Character 레이어
- 적 본체에는 Character 레이어
- 적의 무기에는 Weapon 레이어
- 이렇게 하면 주인공과 적은 서로를 지나칠 수 있으면서도 무기에 의한 충돌 트리거는 정상 작동함
- 주인공 무기도 Weapon 레이어로 해야만 무기 공격 판정에 상호작용 가능한 물체가 반응하는 것을 예방할 수 있음

### 경직 및 경직 저항력
- None, Weak(평타), Strong(긴급 회피)으로 분류
- 잡몹은 평상시에 경직 저항력이 None이지만 공격 모션에는 Weak 저항을 가짐
- 보스는 평상시에 경직 저항력이 Weak이지만 패턴 시전 중에는 Strong 저항을 가짐
- 경직 저항력 이하의 공격은 데미지는 입어도 경직 & 넉백은 무시함

### OneWayPlatform 태그
- 아래 방향키를 두 번 빠르게 눌러 바닥으로 뚫고 들어가려면  
해당 플랫폼이 Ground 레이어이고 "OneWayPlatform"이라는 태그를 가져야 함.

### 공격 애니메이션 새로 임포트할 때 아래 이벤트 추가해줘야 함
1. OnEnableAttackCollider, OnDisableAttackCollider
  - 실제 공격 판정의 시작과 끝에 설정
2. OnBeginAttackInputBuffering
  - 공격 판정이 시작되는 프레임의 바로 다음 프레임에 설정
  - 이 이벤트가 실행되기 전에는 공격 키를 눌러도 선입력으로 취급되지 않음
3. OnStartWaitingAttackContinuation
  - 선입력을 처리해 다음 공격 모션으로 넘어갈 시점에 설정
  - 이 이벤트를 없애면 자세 복귀 모션을 강제할 수 있음  
    => 지금은 마지막 공격 모션에 이걸 없애서 연속 공격 사이에 딜레이를 넣어주고 있음
4. OnAttackMotionEnd
  - 공격 모션의 제일 마지막 프레임에 설정
  - PlayerManager가 공격 모션 종료를 이 이벤트로 판단함!
  
### 공격 애니메이션들의 pivot은 중심으로 고정되지 않고 계속 변함!
- PlayerManager의 ApplyAttackRootMotion() 함수 참고 바람
- 원본 에셋 자체에 이동이 포함되어서 이를 스프라이트 상의 이동이 아니라  
rigidbody의 이동으로 변환하기 위해 꼼수를 조금 썼음
- 처음 보면 이게 뭐지 싶을 수 있으니 주석을 꼭 읽어주십쇼
- 이 방식을 계속 사용할거면 다음 요구조건을 만족해야 함
  1. 공격 애니메이션의 그림 자체에 이동이 포함될 것 (캐릭터가 이동하면 중심에서 벗어나야 함)
  2. 유니티에 에셋 임포트한 뒤 프레임 별로 pivot을 수동으로 중심에 맞춰줄 것

### 캐릭터 콜라이더를 발보다 조금 위로 설정해야 지면과 접촉하는 것으로 표시됨
- 정확히 발 밑까지 포함시키면 어째서인지 공중에 떠있는 것처럼 보임

### 엘리베이터 위에 있을 때 parent object를 엘리베이터로 설정하는 이유
- parent 설정이 없으면 엘리베이터 하강 속도가 조금만 빨라져도 플레이어가 낙하와 착지를 반복함
- 엘리베이터에 서있는 동안만 child로 넣어주면 수직 속도가 동기화되어서 안정적으로 서있을 수 있다!

### UI 요소들의 입력 처리 방식
- 최상단 UI만 입력을 처리하도록 스택 구조를 채용함
- UI가 생길 때 UserInterfaceStack.PushUserInterface(this),  
UI가 사라질 때 UserInterfaceStack.PopUserInterface(this)를 호출해줘야 함.